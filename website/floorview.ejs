<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <%- include('header') %>
  <link rel="stylesheet" href="./stylesheet.css">

</head>

<body>
  <div class="table">
    <div class="row title">
      <div class="col text-center">
        Floorview
      </div>
      <div class="col text-center">
        Aircon Control
      </div>
      <div class="col text-center" id="moreDetailTitle">
        Zone Details
      </div>
    </div>
    <div class="row">
      <div class="col-8">
        <div class="table mt-0">
          <div class="row">
            <div class="col">
              <div class="row" style="background-color: rgba(240, 248, 255, 0);">
                <div class="col-6 m-4">
                  <canvas class="p-0" id="shadeCanvas" style="position: absolute; z-index: -1;  "></canvas>
                  <img src="https://placehold.co/600x400" alt="" id="floorplan" style="position: absolute; top: 0; left: 0;" usemap="#testmap" />
                </div>
                <div class="col m-3">
                  <div class="table placeholder-text" id="controlTable">
                    -click on a zone to view details-
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-6 ms-5">
                  <div class="row">
                    <div class="col-1 m-0 text-center">cold</div>
                    <div class="col-3" id="grad"></div>
                    <div class="col-1 text-center">hot</div>
                  </div>
                </div>

              </div>
            </div>
          </div>
          <div class="row title mt-3">
            <div class="col text-center">
              Energy Use
            </div>
            <div class="col text-center">
              Total Energy used Current Month
            </div>
          </div>
          <div class="row">
            <div class="col-6 ">
              <div class="row ">
                <div class="col">
                  <input type="date" id="datepicker" class="form-control" value="<%= new Date().toISOString().split('T')[0] %>">
                  <!-- '2023-06-21T00:00:00.000Z' split at-->
                </div>
                <div class="col-6">
                  <select id="timeGranularity" class="form-control select">
                    <option value="day">Day</option>
                    <option value="week">Week</option>
                    <option value="month">Month</option>
                    <option value="year">Year</option>
                  </select>
                </div>

              </div>

              <canvas id="energyChart"> </canvas>
            </div>
            <div class="col d-flex justify-content-center">
              <div class="mt-3 d-flex meter">

                <!-- meter -->
                <div class="container Energy-meter " id="energyMeter">
                  Error
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col m-2" style="overflow-y:scroll; height: 90vh;" id="moreDetails"></div>
    </div>
    <div class="offcanvas offcanvas-bottom" tabindex="-1" id="offcanvas" aria-labelledby="offcanvasLabel">
      <div class="offcanvas-header alert-text">
        Alerts
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body m-3" id="AlertMessages" style="overflow-y:scroll">
        <ul id="alertMessageList">

        </ul>
      </div>
    </div>

    <div class="fixed-bottom title ms-1 alert-text ps-3 m-0" id="warning">

      ^Alerts
    </div>
  </div>
  </div>
  <map name="testmap" id="testmap">
  </map>
  <!-- Modal -->
  <div id="infoModal" class="modal p-3" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Modal title</h5>
          <button class="btn btn-secondary" style="position: absolute; top: 10px; right: 10px" id="editButton">
            Edit
          </button>
        </div>
        <div class="modal-body">
          <p>Modal body text goes here.</p>
          <canvas id="tempChart"></canvas>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
  <script>
    //function 
    // Check for redirected floor
    var url = new URL(window.location.href);
    var floorname = url.searchParams.get("floorname");
    if (floorname) {
      cacheData("pastFloorSelection", floorname);

    }

    function monthNameToNumber(monthName) {
      // Mapping of month names to their respective numbers
      //used for chart
      const monthMap = {
        "January": 1,
        "February": 2,
        "March": 3,
        "April": 4,
        "May": 5,
        "June": 6,
        "July": 7,
        "August": 8,
        "September": 9,
        "October": 10,
        "November": 11,
        "December": 12
      };

      return monthMap[monthName];
    }

    function daysInMonth(month, year) {
      return new Date(year, month + 1, 0).getDate();
    }

    function getZone(floorlevel, zoneName) {
      var floor = ejsData.find(element => {
        return element.floorlevel == floorlevel
      })
      var zone = floor.zones.find(element => {
        return element.name == zoneName
      })
      return zone;
    }

    function initializeCanvas() {
      var width = $("#floorplan").width();
      var height = $("#floorplan").height();
      console.log(width, height);
      var canvas = document.getElementById("shadeCanvas");
      canvas.width = width;
      canvas.height = height;
    }

    function cacheData(key, value) {
      localStorage.setItem(key, value);
    }

    function retrieveData(key) {
      return localStorage.getItem(key);
    }
  </script>
  <script>
    var ejsData = <%- JSON.stringify(data) %>;
  </script>
  <script>
    var orginalSensorData = <%- JSON.stringify(sensorData) %>;
  </script>
  <script>
    var originalEnergyData = <%- JSON.stringify(energyData) %>;
  </script>
  <script>
    var alertCount = 0;
    var currentClickedZone;
    floorNames = []
    $("#floorSelector").empty();

    function poupulateFloorSelector(floorSelectorID) {
      for (var data in ejsData) {
        var option = document.createElement('option');
        option.value = ejsData[data].floorlevel;
        option.text = ejsData[data].floorlevel; // Assuming you want to use the same value for the display text
        $("#" + floorSelectorID).append(option);
        floorNames.push(ejsData[data].floorlevel);
      }
    }
    poupulateFloorSelector("floorSelector");
    var energyData = {};




    function loadData() {
      // Clear alerts
      $("#alertMessageList").empty();

      if (document.getElementById("lastUpdatedTime")) {
        document.getElementById("lastUpdatedTime").textContent = "Updated Time: " + new Date().toLocaleTimeString([], {
          hour: '2-digit',
          minute: '2-digit'
        });
      }


      floorlevel = $("#floorSelector").val();
      zones = ejsData.find(obj => obj.floorlevel == floorlevel).zones;
      try {
        var image = document.getElementById("floorplan");
        $(image).mapster('unbind');
        var floorplan = ejsData.find(obj => obj.floorlevel == floorlevel).floorplan;
        image.src = floorplan;
      } catch (error) {
        console.error("Error setting floorplan image:", error);
      }
      try {
        for (zone in zones) {
          var timestampTemperaturePairs = []; // Changed from timestampZonePairs
          for (data in orginalSensorData) {
            if (orginalSensorData[data].hasOwnProperty("metaData")) {
              if (orginalSensorData[data].metaData.zone == zones[zone].name && orginalSensorData[0].metaData.floor == floorlevel) {
                //push new data here
                timestampTemperaturePairs.push({
                  floor: orginalSensorData[data].metaData.floor,
                  zone: orginalSensorData[data].metaData.zone,
                  temperature: orginalSensorData[data].temperature,
                  timestamp: orginalSensorData[data].timestamp,
                  setTemperature: orginalSensorData[data].setTemperature,
                  upperMargin: orginalSensorData[data].setTemperature +
                    orginalSensorData[data].upperMargin,
                  lowerMargin: orginalSensorData[data].setTemperature -
                    orginalSensorData[data].lowerMargin,
                  humidity: orginalSensorData[data].humidity,
                });
              }
            }
          }
          sensorData[zones[zone].name] = timestampTemperaturePairs;
        }
      } catch (error) {
        console.error("Error setting sensor data:", error);
      }

      try {
        var timestampEnergyPairs = [];
        for (data in originalEnergyData) {
          if (originalEnergyData[data].metaData.floor == floorlevel) {
            timestampEnergyPairs.push({
              floor: originalEnergyData[data].metaData.floor,
              energy: originalEnergyData[data].energy,
              timestamp: originalEnergyData[data].timestamp
            });
          }
          floor = $('#floorSelector').val();
          energyData[floor] = timestampEnergyPairs;
        }
      } catch (error) {
        console.error("Error setting energy data:", error);
      }

    }
  </script>
  <script>
    var timestampTemperaturePairs = [];
    var zones;
    var imagemap = document.getElementById("testmap");
    var modal = document.getElementById("infoModal");
    var shadeCanvas = document.getElementById("shadeCanvas");
    var ctx = shadeCanvas.getContext("2d");
    var dynamicCharts = {};
    var image = document.querySelector("img");
    image.src = floorplan;
    var sensorData = {};
    loadData();
    socket.on("floorDetails", function(data) {
      console.log('change', data.Status);
      var floor = data.floorlevel;
      var zones = data.zone;
      var setTemperature = data.setTemperature;
      var Status = data.Status;
      console.log("received floor details floor: " + floor + " zones: " + zones + " setTemperature: " + setTemperature);

      //set new setTemp
      ejsData.find(element => {
        return element.floorlevel == floor
      }).zones.find(element => {
        return element.name == zones
      }).setTemperature = setTemperature;

      //set new aircon State : issue using converting to boolean. Limitation: socket can only pass string type 
      if (data.airconState == "true") {
        ejsData.find(element => {
          return element.floorlevel == floor
        }).zones.find(element => {
          return element.name == zones
        }).airconState = true;
      } else {
        ejsData.find(element => {
          return element.floorlevel == floor
        }).zones.find(element => {
          return element.name == zones
        }).airconState = false;
      }

      //set new light state
      if (data.lightState == "true") {
        ejsData.find(element => {
          return element.floorlevel == floor
        }).zones.find(element => {
          return element.name == zones
        }).lightState = true;
      } else {
        ejsData.find(element => {
          return element.floorlevel == floor
        }).zones.find(element => {
          return element.name == zones
        }).lightState = false;
      }

      if (currentClickedZone) {
        loadDetails(currentClickedZone);
      }
      loadData();
      createArea();
      updateTemperature();
    })
    socket.on("sensorData", function(data) {
      orginalSensorData = data.sensorData;
      console.log("received sensor data");
      loadData();
      createArea();
      if (currentClickedZone) {
        loadDetails(currentClickedZone);
      }
      updateTemperature();
    });
    socket.on("energyData", function(data) {
      originalEnergyData = data.energyData;
      alertCount = 0;
      loadData();
      createArea();
      updateTemperature();
      updateEnergy();
      loadEnergyChart()
      console.log("received energy data");
    });
    createArea();
    updateTemperature();

    function openModal() {
      modal.style.display = "block";
    }

    function closeModal() {
      document.getElementById("editButton").style.display = "block";
      var updateElement = document.getElementById("update");
      if (updateElement) {
        updateElement.remove();
      }

      modal.style.display = "none";
    }

    function createArea() {
      while (imagemap.firstChild) {
        imagemap.removeChild(imagemap.firstChild);
      }
      for (var zone in zones) {
        if (zones[zone].shape == "rect") {
          var image = document.getElementById("floorplan");
          var coordinates = zones[zone];
          var area = document.createElement("area");
          startX = (coordinates.startX / coordinates.orginalImageWidth) * coordinates.orginalMapWidth;
          startY = (coordinates.startY / coordinates.orginalImageHeight) * coordinates.orginalMapHeight;
          endX = (coordinates.endX / coordinates.orginalImageWidth) * coordinates.orginalMapWidth;
          endY = (coordinates.endY / coordinates.orginalImageHeight) * coordinates.orginalMapHeight;

          area.setAttribute("shape", "rect");
          area.setAttribute(
            "coords",
            startX +
            "," +
            startY +
            "," +
            endX +
            "," +
            endY
          );
          area.setAttribute("href", "#");
          area.setAttribute("id", zones[zone].name);
          imagemap.appendChild(area);
        } else if (zones[zone].shape == "poly") {
          var coordinates = zones[zone];
          var area = document.createElement("area");

          area.setAttribute("shape", "poly");
          var coords = "";
          for (var i = 0; i < zones[zone].xCords.length; i++) {
            coords += (zones[zone].xCords[i] / coordinates.orginalImageWidth * coordinates.orginalMapWidth) + "," +
              (zones[zone].yCords[i] / coordinates.orginalImageHeight * coordinates.orginalMapHeight) + ",";
          }

          coords = coords.slice(0, -1);
          area.setAttribute("coords", coords);
          area.setAttribute("href", "#");
          area.setAttribute("id", zones[zone].name);
          imagemap.appendChild(area);
        }
      }
      $("img").mapster({
        showToolTip: true,
        mapKey: "id",
        singleSelect: true,
        toolTipContainer: '<div style="padding: 10px; background-color: white; color: black; border: 2px solid red;"></div>',
        enableAutoResizeSupport: true,
        autoResize: true,

        onClick: function(e) {
          loadDetails(e);

        },
        onAutoResize: function() {
          var image = document.getElementById("floorplan");
          var width = image.clientWidth;
          var height = image.clientHeight;
          var canvas = document.getElementById("shadeCanvas");
          canvas.width = width;
          canvas.height = height;
          updateTemperature(); // imagemapster clears canvas on resize thus need redraw
        }
      });
      try {
        var areaOptions = {
          key: zones[zone].name,
          toolTip: zones[zone].name + "<br> Aircon State:   " + (zones[zone].airconState ? "ON" : "OFF") + " <br> Light State: " + (zones[zone].lightState ? "ON" : "OFF") + "<br> Set Temperature:" + zones[zone].setTemperature + "°C",
        };

        $("img").mapster("set_options", {
          areas: [{
            key: areaOptions.key,
            toolTip: areaOptions.toolTip,
          }],
        });
      } catch (error) {
        console.error("Error setting tooltip in ImageMapster:", error);
      }
    }

    function updateTemperature() {
      ctx.clearRect(0, 0, shadeCanvas.width, shadeCanvas.height);
      var temp;
      for (var zone in zones) {
        for (var data in sensorData) {
          if (sensorData[data].zone == zones[zone].name) {
            temp = sensorData[data].temperature;
          }
        }
        try {
          var areaOptions = {
            key: zones[zone].name,
            toolTip: zones[zone].name + "<br> Aircon State:   " + (zones[zone].airconState ? "ON" : "OFF") + " <br> Light State: " + (zones[zone].lightState ? "ON" : "OFF") + "<br> Set Temperature: " + zones[zone].setTemperature + "°C",
          };

          $("img").mapster("set_options", {
            areas: [{
              key: areaOptions.key,
              toolTip: areaOptions.toolTip,
            }],
          });
        } catch (error) {
          console.error("Error setting tooltip in ImageMapster:", error);
        }
        if (zones[zone].shape == "rect") {
          var zonePosition = zones[zone];
          var startX = (zonePosition.startX / zonePosition.orginalImageWidth) * shadeCanvas.width;
          var startY = (zonePosition.startY / zonePosition.orginalImageWidth) * shadeCanvas.width;
          var endX = (zonePosition.endX / zonePosition.orginalImageHeight) * shadeCanvas.height;
          var endY = (zonePosition.endY / zonePosition.orginalImageHeight) * shadeCanvas.height;
        }
        var zoneDetails = getZone($('#floorSelector').val(), zones[zone].name);
        if (zoneDetails.airconState == true) {
          try {
            console.log(zones[zone].name);
            var setTemp = zoneDetails.setTemperature;
            var temp = sensorData[zones[zone].name][0].temperature;
            var upper = sensorData[zones[zone].name][0].upperMargin;
            var lower = sensorData[zones[zone].name][0].lowerMargin;
            console.log("temp", temp, "upper", upper, "lower", lower, "setTemp", setTemp);

            // Corrected condition
            if (temp <= upper && temp >= lower) {
              ctx.fillStyle = "green"; // Set fillStyle to green
              console.log("green");
            }
            if (temp > upper) {
              ctx.fillStyle = "red";
            }
            if (temp < lower) {
              ctx.fillStyle = "blue";
            }
          } catch (error) {
            console.log(zones[zone].name + " has no sensor data");
            console.log("Error setting temperature gradient:", error);

            ctx.fillStyle = "rgba(128, 128, 128, 0.5)"; // Set fillStyle to grey
          }
        } else if (zoneDetails.airconState == false) {
          console.log("zone is off");
          ctx.fillStyle = "rgba(128, 128, 128, 0.5)"; // Set fillStyle to grey
        } else {
          console.log("zone status is not boolean")
        }
        if (zones[zone].shape == "rect") {
          ctx.beginPath();
          ctx.rect(startX, startY, endX - startX, endY - startY);
          ctx.fill();


        } else if (zones[zone].shape == "poly") {
          var zonePosition = zones[zone];
          var orginalImageHeight = zonePosition.orginalImageHeight;
          var orginalImageWidth = zonePosition.orginalImageWidth;
          var orginalMapHeight = zonePosition.orginalMapHeight;
          var orginalMapWidth = zonePosition.orginalMapWidth;
          ctx.beginPath();
          ctx.moveTo(zonePosition.xCords[0] / orginalImageWidth * shadeCanvas.width, zonePosition.yCords[0] / orginalImageHeight * shadeCanvas.height);
          for (var i = 1; i < zonePosition.xCords.length; i++) {
            ctx.lineTo(zonePosition.xCords[i] / orginalImageWidth * shadeCanvas.width, zonePosition.yCords[i] / orginalImageHeight * shadeCanvas.height);
          }
          ctx.closePath();
          ctx.fill();



        }
      }
    }



    updateTemperature();
  </script>
  <script>
    $(document).ready(function() {
      const initializeFloor = () => {
        var floor = $('#floorSelector').val();
        $("img").mapster('unbind');
        cacheData("pastFloorSelection", floor);
        document.getElementById("moreDetails").innerHTML = "-click on a zone to view details-";
        document.getElementById("controlTable").innerHTML = "-click on a zone to view details-";
        document.getElementById("moreDetails").classList.add("text-center");

        loadData();
        updateEnergy();
        createArea();
        updateTemperature();
        loadEnergyChart();
      };

      $('#floorSelector').on('change', initializeFloor);


      // Load past floor data from cache
      var pastFloorSelection = retrieveData("pastFloorSelection");
      if (pastFloorSelection) {
        console.log("Loaded past floor selection: " + pastFloorSelection);
        $('#floorSelector').val(pastFloorSelection);
        initializeFloor();
      }


    });



    function loadTempChart(key) {
      var temp = [];
      var upper = [];
      var lower = [];
      var set = [];
      var labels = [];

      var dynamicChartName = "tempChart_" + key;
      var currentTime = new Date();
      var timeGranularity = document.getElementById("sensorDataTimeGranuality").value;



      // Get the sensor data for the given zone key
      var zoneData = sensorData[key];
      if (zoneData) {
        // Iterate over the sensor data and push to temp and labels arrays
        for (var i = 0; i < zoneData.length; i++) {
          var tempTime = new Date(zoneData[i].timestamp);
          if (timeGranularity == "hour") {
            if (tempTime.getTime() >= currentTime.getTime() - 3600000) {
              labels.push(tempTime.getHours() + ":" + tempTime.getMinutes() + ":" + tempTime.getSeconds());
              upper.push(zoneData[i].upperMargin);
              lower.push(zoneData[i].lowerMargin);
              set.push(zoneData[i].setTemperature);
              temp.push(zoneData[i].temperature.toFixed(2));
            }
          } else {
            if (tempTime.getTime() >= currentTime.getTime() - (3600000 * 24)) {
              labels.push(tempTime.getHours() + ":" + tempTime.getMinutes() + ":" + tempTime.getSeconds());
              upper.push(zoneData[i].upperMargin);
              lower.push(zoneData[i].lowerMargin);
              set.push(zoneData[i].setTemperature);
              temp.push(zoneData[i].temperature.toFixed(2));
            }
          }
        }
      }


      var tempChart = document.createElement("canvas");
      var tempCtx = tempChart.getContext("2d");
      var time = new Date().toISOString().split("T")[1].substring(0, 8);
      var data = {
        labels: labels,
        datasets: [{
            label: "temperature",
            data: temp,
            fill: false,
            hoverBackgroundColor: "rgba(75, 192, 192, 0.4)",
            borderColor: "rgb(75, 192, 192)",
            tension: 0.1,
            pointStyle: "none",
            pointRadius: 1,
            spanGaps: true // Enable span gaps
          },
          {
            label: "uppermargin",
            data: upper,
            fill: false,
            borderColor: "red",
            tension: 0.1,
            pointRadius: 1,
            pointStyle: "dash",
            spanGaps: true // Enable span gaps
          },
          {
            label: "lowermargin",
            data: lower,
            fill: false,
            borderColor: "blue",
            tension: 0.1,
            pointRadius: 1,
            pointstyle: "dash",
            spanGaps: true // Enable span gaps
          },
          {
            label: "set Temperature",
            data: set,
            fill: false,
            borderColor: "green",
            tension: 0.1,
            pointRadius: 1,
            pointstyle: "dash",
            spanGaps: true // Enable span gaps
          },
        ],
      };
      temp.reverse();
      labels.reverse();
      upper.reverse();
      lower.reverse();
      set.reverse();
      var tempConfig = {
        type: "line",
        data: data,
        options: {
          plugins: {
            legend: {
              display: false, // Remove legend
            },
          },
          animation: false,

        },
      };
      var tempContainer = document.createElement("div");
      tempContainer.id = "tempContainer";
      if (timeGranularity == "hour") {
        tempContainer.textContent = "Temperature over past hour (°C)";
      } else {
        tempContainer.textContent = "Temperature over past day (°C)";
      }
      tempContainer.classList.add("p-3", "text-center", "border")
      tempContainer.appendChild(tempChart);

      dynamicCharts[dynamicChartName] = new Chart(tempCtx, tempConfig);
      document.getElementById("moreDetails").appendChild(tempContainer);


    }


    function loadHumidityChart(key) {

      var HumidityChartContainer = document.createElement("div");
      var timeGranularity = document.getElementById("sensorDataTimeGranuality").value;
      if (timeGranularity == "hour") {
        HumidityChartContainer.textContent = "Humidity over past hour (RH%)";
      } else {
        HumidityChartContainer.textContent = "Humidity over past day (RH%)";
      }
      HumidityChartContainer.id = "HumidityContainer";
      var HumidityChart = document.createElement("canvas");
      var HumidityCtx = HumidityChart.getContext("2d");

      HumidityChartContainer.classList.add("p-3", "mt-2", "text-center", "border")
      HumidityChartContainer.appendChild(HumidityChart);




      var moreDetails = document.getElementById("moreDetails");

      moreDetails.appendChild(HumidityChartContainer);
      var humidityChart = document.createElement("canvas");
      var humidityCtx = humidityChart.getContext("2d");

      var humi = [];
      var labels = [];
      var dynamicChartName = "humidityChart_" + key;
      var currentTime = new Date();

      var zoneData = sensorData[key];
      if (zoneData) {
        for (var i = 0; i < zoneData.length; i++) {
          var tempTime = new Date(zoneData[i].timestamp);
          if (timeGranularity == "hour") {
            if (tempTime.getTime() >= currentTime.getTime() - 3600000) {
              humi.push(zoneData[i].humidity.toFixed(2));
              labels.push(tempTime.getHours() + ":" + tempTime.getMinutes() + ":" + tempTime.getSeconds());
            }
          } else {
            if (tempTime.getTime() >= currentTime.getTime() - (3600000 * 24)) {
              humi.push(zoneData[i].humidity.toFixed(2));
              labels.push(tempTime.getHours() + ":" + tempTime.getMinutes() + ":" + tempTime.getSeconds());
            }
          }

        }
      }
      humi.reverse();
      labels.reverse();

      var data = {
        labels: labels,
        datasets: [{
          label: "humidity",
          data: humi,
          fill: false,
          borderColor: "rgb(75, 192, 192)",
          tension: 0.1,
          pointStyle: "none",
          spanGaps: false,
          pointRadius: 1,
        }, ],
      };
      var config = {
        type: "line",
        data: data,
        options: {
          plugins: {
            legend: {
              display: false,
            },
          },
          animation: false,
        },
      };

      dynamicCharts[dynamicChartName] = new Chart(HumidityCtx, config);


    }

    function loadPIRChart(key) {
      var PIRChart = document.createElement("canvas");
      var PIRChartContainer = document.createElement("div");
      PIRChartContainer.id = "pirContainer";
      PIRChartContainer.textContent = "PIR triggered over past hour";
      PIRChartContainer.classList.add("p-3", "mt-2", "text-center", "border")
      PIRChartContainer.appendChild(PIRChart);

      var moreDetails = document.getElementById("moreDetails");
      moreDetails.appendChild(PIRChartContainer);
    }

    updateTemperature();
  </script>
  <script>
    function loadDetails(zone) {
      if (currentClickedZone != zone) {
        currentClickedZone = zone;
        var title = document.getElementById("moreDetailTitle");
        title.textContent = "Zone Details: " + zone.key;
        var table = document.getElementById("moreDetails");
        table.innerHTML = "";
        rowhead = document.createElement("div");
        rowhead.classList.add("row", "m-2");


        col1 = document.createElement("div");
        col1.classList.add("col", "text-start");

        col2 = document.createElement("div");
        col2.classList.add("col", "justify-content-end", "text-end", "d-flex");

        var sensorDataTimeGranuality = document.createElement("select");
        sensorDataTimeGranuality.classList.add("form-select", "select", "sensorTimeSelect");
        sensorDataTimeGranuality.id = "sensorDataTimeGranuality";
        var sensorDataTimeGranualityOption1 = document.createElement("option");
        sensorDataTimeGranualityOption1.value = "hour";
        sensorDataTimeGranualityOption1.textContent = "Hour";
        var sensorDataTimeGranualityOption2 = document.createElement("option");
        sensorDataTimeGranualityOption2.value = "day";
        sensorDataTimeGranualityOption2.textContent = "Day";

        sensorDataTimeGranuality.addEventListener("change", function() {
          dynamicCharts["tempChart_" + currentClickedZone.key].destroy();
          dynamicCharts["humidityChart_" + currentClickedZone.key].destroy();
          try {
            document.getElementById("tempContainer").remove();
          } catch (error) {
            console.log("Error removing tempContainer:", error);
          }
          try {
            document.getElementById("HumidityContainer").remove();
          } catch (error) {
            console.log("Error removing HumidityContainer:", error);
          }
          try {
            document.getElementById("pirContainer").remove();
          } catch (error) {
            console.log("Error removing PIRContainer:", error);
          }
          loadCharts(currentClickedZone.key);
        });

        sensorDataTimeGranuality.appendChild(sensorDataTimeGranualityOption1);
        sensorDataTimeGranuality.appendChild(sensorDataTimeGranualityOption2);




        col2.appendChild(sensorDataTimeGranuality);

        var moreDetailsButton = document.createElement("submit");
        moreDetailsButton.classList.add("btn", "btn-primary");
        moreDetailsButton.textContent = "More Details";
        var floorlevel = $('#floorSelector').val();
        moreDetailsButton.addEventListener("click", function() {
          window.location.href = "/moreDetails/?zone=" + zone.key + "&floorlevel=" + floorlevel;
        });
        col1.appendChild(moreDetailsButton);

        rowhead.appendChild(col1);
        rowhead.appendChild(col2);

        table.appendChild(rowhead);

        var zoneName = zone.key;



        var table = document.getElementById("controlTable")
        table.innerHTML = "";
        var zoneName = zone.key;
        var row1 = document.createElement("div");
        row1.classList.add("row", "align-items-center", "justify-content-center", "text-center");

        var title = document.createElement("div")
        title.classList.add("col", "text-center");
        title.textContent = zoneName;

        var editnStateIndicatorContainer = document.createElement("div");
        editnStateIndicatorContainer.classList.add("row", "align-content-end", "text-end", "switch-table-height");


        var editButtonContainer = document.createElement("div");
        editButtonContainer.classList.add("col", "align-content-start", "text-start");

        var switchContainer = document.createElement("div");
        switchContainer.classList.add("col");

        var switchTable = document.createElement("div");
        switchTable.classList.add("table");

        var airconSwitchRow = document.createElement("div");
        airconSwitchRow.classList.add("row", "align-items-center", "justify-content-center", "text-center");

        var airconStateIndicatorContainer = document.createElement("div");
        airconStateIndicatorContainer.classList.add("col", "text-center", "d-flex", "justify-content-end", "align-items-end", "indicator-text");

        var airconStateIndicator = document.createElement("div");
        airconStateIndicator.classList.add("form-check", "form-switch");

        var airconStateIndicatorInput = document.createElement("input");
        airconStateIndicatorInput.classList.add("form-check-input");
        airconStateIndicatorInput.setAttribute("role", "switch");
        airconStateIndicatorInput.setAttribute("type", "checkbox");
        airconStateIndicatorInput.setAttribute("id", "airconStateSwitch");
        airconStateIndicatorInput.setAttribute("checked", "true");

        var zoneDetails = getZone(floorlevel, zoneName);
        if (zoneDetails.airconState == true || zoneDetails.airconState == "true") {
          airconStateIndicatorInput.checked = true;
        } else {
          airconStateIndicatorInput.checked = false;
        }



        airconStateIndicatorInput.disabled = true;
        airconStateIndicatorInput.id = "airconStateIndicatorInput"

        var airconStateIndicatorLabel = document.createElement("label");
        airconStateIndicatorLabel.classList.add("form-check-label");
        airconStateIndicatorLabel.setAttribute("for", "airconStateSwitch");
        airconStateIndicatorLabel.textContent = "Aircon";


        airconStateIndicatorContainer.appendChild(airconStateIndicator);
        airconStateIndicator.appendChild(airconStateIndicatorInput);
        airconStateIndicator.appendChild(airconStateIndicatorLabel);
        airconSwitchRow.appendChild(airconStateIndicatorContainer);

        lightSwitchRow = document.createElement("div");
        lightSwitchRow.classList.add("row", "align-items-center", "justify-content-center", "text-center", "switch-remove-gap");

        lightStateIndicatorContainer = document.createElement("div");
        lightStateIndicatorContainer.classList.add("col", "text-center", "d-flex", "justify-content-end", "align-items-end", "indicator-text");

        lightStateIndicator = document.createElement("div");
        lightStateIndicator.classList.add("form-check", "form-switch");

        lightStateIndicatorInput = document.createElement("input");
        lightStateIndicatorInput.classList.add("form-check-input");
        lightStateIndicatorInput.setAttribute("role", "switch");
        lightStateIndicatorInput.setAttribute("type", "checkbox");
        lightStateIndicatorInput.setAttribute("id", "lightStatusSwitch");
        lightStateIndicatorInput.setAttribute("checked", "true");
        if (zoneDetails.lightState == true || zoneDetails.lightState == "true") {
          lightStateIndicatorInput.checked = true;
        } else {
          lightStateIndicatorInput.checked = false;
        }
        lightStateIndicatorInput.disabled = true;
        lightStateIndicatorInput.id = "lightStateIndicatorInput"

        lightStateIndicatorLabel = document.createElement("label");
        lightStateIndicatorLabel.classList.add("form-check-label");
        lightStateIndicatorLabel.setAttribute("for", "lightStatusSwitch");
        lightStateIndicatorLabel.textContent = "Lights";

        lightStateIndicatorContainer.appendChild(lightStateIndicator);
        lightStateIndicator.appendChild(lightStateIndicatorInput);
        lightStateIndicator.appendChild(lightStateIndicatorLabel);
        lightSwitchRow.appendChild(lightStateIndicatorContainer);




        switchTable.appendChild(airconSwitchRow);
        switchTable.appendChild(lightSwitchRow);
        switchContainer.appendChild(switchTable);




        editnStateIndicatorContainer.appendChild(editButtonContainer);
        editnStateIndicatorContainer.appendChild(switchContainer);



        var editButton = document.createElement("button");
        editButton.classList.add("btn", "btn-secondary", "text-en", "editButton", "indicator-text");
        editButton.textContent = "Edit";
        editButton.addEventListener("click", function() {
          var zone = getZone(floorlevel, currentClickedZone.key);
          editTemp = zone.setTemperature;
          tempReading.textContent = editTemp + "C";

          //add state indicator toggle switch
          airconStateIndicatorInput.disabled = false;
          lightStateIndicatorInput.disabled = false;
          var airconStateIndicatorToggle = document.createElement("input")


          var increaseButtonContianer = document.createElement("div");
          increaseButtonContianer.classList.add("col", "text-center", "d-flex", "justify-content-center", "align-items-center");
          var increaseButton = document.createElement("button");
          increaseButton.classList.add("btn", "btn-success");
          increaseButton.textContent = "+";
          increaseButton.addEventListener("click", function() {
            editTemp += 1;
            tempReading.textContent = editTemp + "C";
          });
          increaseButtonContianer.appendChild(increaseButton);


          var decreaseButtonContianer = document.createElement("div");
          decreaseButtonContianer.classList.add("col", "text-center", "d-flex", "justify-content-center", "align-items-center");
          var decreaseButton = document.createElement("button");
          decreaseButton.classList.add("btn", "btn-danger");
          decreaseButton.textContent = "-";
          decreaseButton.addEventListener("click", function() {
            editTemp -= 1;
            tempReading.textContent = editTemp + "C";
          });
          decreaseButtonContianer.appendChild(decreaseButton);


          row2.innerHTML = "";
          row2.appendChild(increaseButtonContianer);
          row2.appendChild(tempReading);
          row2.appendChild(decreaseButtonContianer);
          editButtonContainer.removeChild(editButton);

          var closeButton = document.createElement("button");
          closeButton.classList.add("btn", "btn-danger", "text-en", "editButton");
          closeButton.textContent = "x";
          closeButton.addEventListener("click", function() {
            row2.innerHTML = "";
            row2.appendChild(tempReading);
            editButtonContainer.removeChild(closeButton);
            editButtonContainer.appendChild(editButton);
            table.removeChild(confirmButtonContainer);
            var zone = getZone(floorlevel, currentClickedZone.key);
            tempReading.textContent = zone.setTemperature + "C";
            tempReading.id = "tempReading";
            console.log(zone.Status)
            if (zone.airconState == true) {
              console.log("checked")
              airconStateIndicatorInput.checked = true;
            } else {
              console.log("unchecked")
              airconStateIndicatorInput.checked = false;
            }
            if (zone.lightState == true) {
              lightStateIndicatorInput.checked = true;
            } else {
              lightStateIndicatorInput.checked = false;
            }
            airconStateIndicatorInput.disabled = true;
            lightStateIndicatorInput.disabled = true;

          });
          editButtonContainer.appendChild(closeButton);

          confirmButtonContainer = document.createElement("div");
          confirmButtonContainer.classList.add("row", "text-center");
          var confirmButton = document.createElement("button");
          confirmButton.classList.add("btn", "btn-success", );
          confirmButton.textContent = "Confirm";
          confirmButton.id = "confirmButton";
          confirmButton.addEventListener("click", function() {
            var airconState = document.getElementById("airconStateIndicatorInput").checked;
            airconState = airconState.toLocaleString();

            var lightState = document.getElementById("lightStateIndicatorInput").checked;
            lightState = lightState.toLocaleString();

            console.log("state: ", airconState)
            console.log("editTemp: ", editTemp)
            socket.emit("change", {
              setTemperature: editTemp,
              zone: zoneName,
              floor: floorlevel,
              airconState: airconState,
              lightState: lightState
            })

            row2.innerHTML = "";
            var zone = getZone(floorlevel, currentClickedZone.key);
            tempReading.textContent = zone.setTemperature + "C";
            row2.appendChild(tempReading);
            editButtonContainer.removeChild(closeButton);
            editButtonContainer.appendChild(editButton);
            table.removeChild(confirmButtonContainer);
            airconStateIndicatorInput.disabled = true;
            lightStateIndicatorInput.disabled = true;
          });
          confirmButtonContainer.appendChild(confirmButton);
          table.appendChild(confirmButtonContainer);


        });

        editButtonContainer.appendChild(editButton);
        table.appendChild(editnStateIndicatorContainer);

        var row2 = document.createElement("div");
        row2.classList.add("row");
        var tempReading = document.createElement("div");
        tempReading.classList.add("col", "text-center", "mt-5", "temp-meter");
        tempReading.id = "tempReading";
        tempReading.textContent = "gauge";
        var zone = getZone(floorlevel, currentClickedZone.key);
        tempReading.textContent = zone.setTemperature + "C";



        row1.appendChild(title);
        row2.appendChild(tempReading);


        table.appendChild(row1);
        table.appendChild(row2);
        loadCharts(zoneName);
      } else if (currentClickedZone == zone) {
        if (!document.getElementById("confirmButton")) {
          //currentClickedZone is an object where the name of the clicked zone is in key, named "key". Thus, currentClickedZone.key will net you the name of the clicked zone
          floorlevel = $('#floorSelector').val();
          var tempreading = document.getElementById("tempReading");
          zoneData = getZone(floorlevel, currentClickedZone.key);
          tempreading.textContent = zoneData.setTemperature + "C";
          zone = currentClickedZone.key;
          var timeGranularity = document.getElementById("sensorDataTimeGranuality").value;
          console.log("reusing chart", "tempChart_" + zone, "timeGranularity", timeGranularity);

          var oldDatasest = dynamicCharts["tempChart_" + zone].config.data.datasets;
          var temp = [];
          var upper = [];
          var lower = [];
          var set = [];
          var labels = [];
          var currentTime = new Date();
          var zoneData = sensorData[zone];
          if (zoneData) {
            for (var i = 0; i < zoneData.length; i++) {
      
              var tempTime = new Date(zoneData[i].timestamp);
              if (timeGranularity == "hour") {
                if (tempTime.getTime() >= currentTime.getTime() - 3600000) {
                  temp.push(zoneData[i].temperature.toFixed(2));
                  labels.push(tempTime.getHours() + ":" + tempTime.getMinutes() + ":" + tempTime.getSeconds());
                  upper.push(zoneData[i].upperMargin);
                  lower.push(zoneData[i].lowerMargin);
                  set.push(zoneData[i].setTemperature);
                }
              } else {
                if (tempTime.getTime() >= currentTime.getTime() - (3600000 * 24)) {
                  temp.push(zoneData[i].temperature.toFixed(2));
                  labels.push(tempTime.getHours() + ":" + tempTime.getMinutes() + ":" + tempTime.getSeconds());
                  upper.push(zoneData[i].upperMargin);
                  lower.push(zoneData[i].lowerMargin);
                  set.push(zoneData[i].setTemperature);
                }
              }
            }
          }
          temp.reverse();
          labels.reverse();
          upper.reverse();
          lower.reverse();
          set.reverse();


          //[0,1,2,3] = [temp, upper, lower, set] datasets
          oldDatasest[0].data = temp;
          oldDatasest[1].data = upper;
          oldDatasest[2].data = lower;
          oldDatasest[3].data = set;
          dynamicCharts["tempChart_" + zone].config.data.labels = labels;
          dynamicCharts["tempChart_" + zone].config.datasets = oldDatasest;
          dynamicCharts["tempChart_" + zone].update();

          var humi = [];
          var humiLabels = [];
          for (data in zoneData) {
            humi.push(zoneData[data].humidity.toFixed(2));
            var tempTime = new Date(zoneData[data].timestamp);
            if (timeGranularity == "hour") {
              if (tempTime.getTime() >= currentTime.getTime() - 3600000) {
                humi.push(zoneData[data].humidity.toFixed(2));
                humiLabels.push(tempTime.getHours() + ":" + tempTime.getMinutes() + ":" + tempTime.getSeconds());
              }
            } else {
              if (tempTime.getTime() >= currentTime.getTime() - (3600000 * 24)) {
                humi.push(zoneData[data].humidity.toFixed(2));
                humiLabels.push(tempTime.getHours() + ":" + tempTime.getMinutes() + ":" + tempTime.getSeconds());
              }
            }
          }
          humi.reverse();
          humiLabels.reverse();
          dynamicCharts["humidityChart_" + zone].config.data.labels = humiLabels;
          dynamicCharts["humidityChart_" + zone].config.data.datasets[0].data = humi;
          dynamicCharts["humidityChart_" + zone].update();
        }


      }
    }

    function loadCharts(key) {
      var creationTime = document.getElementById("creationTime");
      loadTempChart(key);
      loadHumidityChart(key);
      loadPIRChart(key);


    }




    function updateEnergy() {
      try {

        var energyAlert = document.createElement("li");
        energyAlert.id = "energyAlert";
        var currentTime = new Date();
        //    console.log(currentTime)
        currentTime = currentTime.getTime();
        energyMeter = document.getElementById("energyMeter");
        var alertList = document.getElementById("alertMessageList");
        alertList.style.listStyle = "none";
        try {
          var tempTime = new Date(energyData["1"][0].timestamp)
          var milisecondtempTime = tempTime.getTime();
        } catch {
          //nothing
        }

        floor = $('#floorSelector').val();
        if (!energyData[floor] || !energyData) {
          energyMeter.textContent = "ERROR";
          energyAlert.textContent = "No Energy Reading available for this floor";
          alertMessageList.appendChild(energyAlert);
          energyMeter.addEventListener("click", function() {
            $('#offcanvas').offcanvas('show')
            energyAlert.classList.add('highlight');
            alertMessageList.appendChild(energyAlert);
            $('#offcanvas').on('hidden.bs.offcanvas', function() {
              energyAlert.classList.remove('highlight');
            });
          });
          var energyCanvas = document.getElementById("energyChart");
          energyCanvas.addEventListener("click", function() {
            $('#offcanvas').offcanvas('show')
            energyAlert.classList.add('highlight');
            alertMessageList.appendChild(energyAlert);
            $('#offcanvas').on('hidden.bs.offcanvas', function() {
              energyAlert.classList.remove('highlight');
            });
          });
          alertCount++;

        } else if (currentTime - milisecondtempTime > 3600000) {
          console.log("updating energy");
          var timeDiffMin = Math.floor(((currentTime - milisecondtempTime) / 60000));
          energyAlert.textContent = "Energy Readings last updated " + new Date(energyData[floorlevel][0].timestamp);
          alertMessageList.innerHTML = "";
          alertMessageList.appendChild(energyAlert);
          alertCount++;


          var currentTime = new Date()
          var year = currentTime.getFullYear();
          var month = currentTime.getMonth();
          var energyDataset = energyData[floor];

          var endEnergyUsed
          for (data in energyDataset) {
            var tempTime = new Date(energyDataset[data].timestamp)
            if (tempTime.getMonth() == month && tempTime.getFullYear() == year) {
              endEnergyUsed = energyDataset[data].energy
              break
            }
          }
          energyDataset.reverse()

          var initalEnergyUsed
          for (data in energyDataset) {
            var tempTime = new Date(energyDataset[data].timestamp)
            if (tempTime.getMonth() == month && tempTime.getFullYear() == year) {
              initalEnergyUsed = energyDataset[data].energy
              break
            }
          }
          energyDataset.reverse()
          var energyUsed = (endEnergyUsed - initalEnergyUsed).toFixed(2);
          energyMeter.textContent = energyUsed + "kwh";

        } else {
          //   console.log("updating energy");
          var currentTime = new Date()
          var year = currentTime.getFullYear();
          var month = currentTime.getMonth();
          var energyDataset = energyData[floor];

          var endEnergyUsed
          for (data in energyDataset) {
            var tempTime = new Date(energyDataset[data].timestamp)
            if (tempTime.getMonth() == month && tempTime.getFullYear() == year) {
              endEnergyUsed = energyDataset[data].energy
              break
            }
          }
          energyDataset.reverse()

          var initalEnergyUsed
          for (data in energyDataset) {
            var tempTime = new Date(energyDataset[data].timestamp)
            if (tempTime.getMonth() == month && tempTime.getFullYear() == year) {
              initalEnergyUsed = energyDataset[data].energy
              break
            }
          }
          energyDataset.reverse()
          var energyUsed = (endEnergyUsed - initalEnergyUsed).toFixed(2);
          energyMeter.textContent = energyUsed + "kwh";
        }
        //  console.log(tempTime)
      } catch (error) {
        alertMessageList.innerHTML = "";
        energyMeter.textContent = "ERROR";
        alertMessageList.appendChild(energyAlert);
        console.log("Error updating energy:", error);
      }
    }

    function loadEnergyChart() {
      var labels = [];
      var energyDataset = [];
      var floorlevel = $('#floorSelector').val();
      var timeGranularity = $('#timeGranularity').val();
      var selectedDay = $('#datepicker').val();
      console.log(selectedDay)

      if (!dynamicCharts["energyChart"]) {
        var energyCanvas = document.getElementById("energyChart");
        var energyCtx = energyCanvas.getContext("2d");

        var [dayEnergyUsed, labels, average] = energyChartValue(timeGranularity, floorlevel, selectedDay)
        console.log(dayEnergyUsed, average)

        var energyChartData = {
          labels: labels,
          datasets: [{
            label: "Energy Used(KWH)",
            data: dayEnergyUsed,
            fill: "yellow",
            backgroundColor: "yellow",
            borderColor: "rgb(196, 196, 0)",
            tension: 0.1,
            radius: 1,
          }, ]
        }



        var energyConfig = {
          type: "bar",
          data: energyChartData,
          options: {
            scales: {
              xAxes: [{
                ticks: {
                  autoSkip: false
                }
              }]
            },
            plugins: {
              legend: {
                display: false,
              },
              title: {
                display: true,
                text: 'Energy used on ' + new Date(selectedDay).toLocaleDateString() + ' (kwh)',
              },

            },
          },
        }

        dynamicCharts["energyChart"] = new Chart(energyCtx, energyConfig);
        energyChartTitle(selectedDay)
        energyCanvas.addEventListener("click", energyClickHandler)
      } else {

        [dayEnergyUsed, labels] = energyChartValue(timeGranularity, floorlevel, selectedDay)

        dynamicCharts["energyChart"].config.data.labels = labels;
        dynamicCharts["energyChart"].config.data.datasets[0].data = dayEnergyUsed;
        dynamicCharts["energyChart"].update();
        energyChartTitle(selectedDay)

      }
    }

    function energyClickHandler(click) {
      var timeGranularity = $('#timeGranularity').val();
      var date = $('#datepicker').val();
      var date = new Date(date);
      var month = date.getMonth();
      var year = date.getFullYear();
      const points = dynamicCharts["energyChart"].getElementsAtEventForMode(click, 'nearest', {
        intersect: true
      }, true);
      if (points.length > 0) {
        const firstPoint = points[0];
        const label = dynamicCharts["energyChart"].data.labels[firstPoint.index];
        const value = dynamicCharts["energyChart"].data.datasets[firstPoint.datasetIndex].data[firstPoint.index];
        if (timeGranularity == "month") {
          var tempTime = new Date(year, month, label + 1)
          var datepicker = document.getElementById("datepicker");
          datepicker.value = tempTime.toISOString().split('T')[0];
          $('#timeGranularity').val("day")
        } else if (timeGranularity == "year") {
          var month = monthNameToNumber(label)
          var tempTime = new Date(year, month, 1)
          var datepicker = document.getElementById("datepicker");
          datepicker.value = tempTime.toISOString().split('T')[0];
          $('#timeGranularity').val("month")
        }
        loadEnergyChart()
      }
    }



    function energyClickHandler(click) {
      var timeGranularity = $('#timeGranularity').val();
      var date = $('#datepicker').val();
      var date = new Date(date);
      var month = date.getMonth();
      var year = date.getFullYear();

      const points = dynamicCharts["energyChart"].getElementsAtEventForMode(click, 'nearest', {
        intersect: true
      }, true);
      if (points.length > 0) {
        const firstPoint = points[0];
        const label = dynamicCharts["energyChart"].data.labels[firstPoint.index];
        const value = dynamicCharts["energyChart"].data.datasets[firstPoint.datasetIndex].data[firstPoint.index];
        if (timeGranularity == "month") {
          var tempTime = new Date(year, month, label + 1)
          var datepicker = document.getElementById("datepicker");
          datepicker.value = tempTime.toISOString().split('T')[0];
          $('#timeGranularity').val("day")
        } else if (timeGranularity == "year") {
          var month = monthNameToNumber(label)
          var tempTime = new Date(year, month, 1)
          var datepicker = document.getElementById("datepicker");
          datepicker.value = tempTime.toISOString().split('T')[0];
          $('#timeGranularity').val("month")
        }
        loadEnergyChart()
      }
    }



    function energyChartTitle(selectedDay) {
      var timeGranularity = $('#timeGranularity').val();
      var average = 0;
      if (timeGranularity == "day") {
        dynamicCharts["energyChart"].config.options.plugins.title.text = 'Energy used on ' + new Date(selectedDay).toLocaleDateString() + ' (kwh)';
      } else if (timeGranularity == "week") {
        let selectedDate = new Date(selectedDay);
        let startDate = new Date(selectedDate);
        startDate.setDate(selectedDate.getDate() - selectedDate.getDay() + 1);
        let endDate = new Date(startDate);
        endDate.setDate(startDate.getDate() + 6);
        dynamicCharts["energyChart"].config.options.plugins.title.text = 'Energy used from ' + startDate.toLocaleDateString() + ' to ' + endDate.toLocaleDateString() + ' (kwh)';
      } else if (timeGranularity == "month") {
        dynamicCharts["energyChart"].config.options.plugins.title.text = 'Energy used during ' + new Date(selectedDay).toLocaleString('default', {
          month: 'long',
          year: 'numeric'
        }) + ' (kwh)';
      } else if (timeGranularity == "year") {
        dynamicCharts["energyChart"].config.options.plugins.title.text = 'Energy used during ' + new Date(selectedDay).getFullYear() + ' (kwh)';
        try {
          var name = currentClickedZone.key;
        } catch {
          console.log("no zone selected")
        }
      }
      dynamicCharts["energyChart"].update();

    }

    function energyChartValue(timeGranularity, floorlevel, selectedDay) {
      var labels = [];
      var selectedDate = new Date(selectedDay)
      var currentDay = selectedDate.getDate()
      var energyDataset = energyData[floorlevel];
      if (timeGranularity == "day") {
        var endEnergyUsed = [];
        for (var i = 0; i < 24; i++) {
          for (data in energyDataset) {
            var tempTime = new Date(energyDataset[data].timestamp);
            if (tempTime.getDate() == currentDay && tempTime.getHours() == i && tempTime.getMonth() == selectedDate.getMonth() && tempTime.getFullYear() == selectedDate.getFullYear()) {
              endEnergyUsed.push(energyDataset[data].energy);
              break;
            }
          }
          if (!endEnergyUsed[i]) {
            endEnergyUsed.push(0); //no energy used for hour
          }
        }
        energyDataset.reverse();

        var initalEnergyUsed = [];
        for (var i = 0; i < 24; i++) {
          for (data in energyDataset) {
            var tempTime = new Date(energyDataset[data].timestamp);
            if (tempTime.getDate() == currentDay && tempTime.getHours() == i && tempTime.getMonth() == selectedDate.getMonth() && tempTime.getFullYear() == selectedDate.getFullYear()) {
              initalEnergyUsed.push(energyDataset[data].energy);
              break;
            }
          }
          if (!initalEnergyUsed[i]) {
            initalEnergyUsed.push(0); //no energy used for hour
          }
        }
        var dayEnergyUsed = []
        for (var i = 0; i < 24; i++) {
          dayEnergyUsed.push(endEnergyUsed[i] - initalEnergyUsed[i]);
        }
        var average = 0;
        for (var i = 0; i < 24; i++) {
          average = average + dayEnergyUsed[i];
        }
        average = (average / 24).toFixed(4);


        for (var i = 0; i < 24; i++) {
          labels.push(i + ":00");
        }

        energyDataset.reverse();

      } else if (timeGranularity == "week") {
        var day = selectedDate.getDay();
        //find the diff from day to 1 start
        var offset = day - 1;
        //find the start of the week
        var start = new Date(selectedDate.setDate(selectedDate.getDate() - offset));
        //push weekdates to labels
        var labels = [];
        for (var i = 0; i < 7; i++) {
          var tempDate = new Date(start);
          tempDate.setDate(tempDate.getDate() + i);
          labels.push(tempDate.toLocaleDateString().split('T')[0]);
        }

        console.log(labels)

        var endEnergy = [];
        var initalEnergyUsed = [];

        for (date in labels) {
          for (data in energyDataset) {
            var tempTime = new Date(energyDataset[data].timestamp);
            var tempTime = tempTime.toLocaleDateString().split('T')[0];
            if (tempTime == labels[date]) {
              endEnergy.push(energyDataset[data].energy);
              break;
            }
          }
          if (!endEnergy[date]) {
            endEnergy.push(0);
          }
        }

        energyDataset.reverse();
        for (date in labels) {
          for (data in energyDataset) {
            var tempTime = new Date(energyDataset[data].timestamp);
            var tempTime = tempTime.toLocaleDateString().split('T')[0];
            if (tempTime == labels[date]) {
              initalEnergyUsed.push(energyDataset[data].energy);
              break;
            }
          }
          if (!endEnergy[date]) {
            initalEnergyUsed.push(0);
          }
        }

        energyDataset.reverse();
        var dayEnergyUsed = []
        for (var i = 0; i < 7; i++) {
          dayEnergyUsed.push(endEnergy[i] - initalEnergyUsed[i]);
        }
        var average = 0;
        for (var i = 0; i < 7; i++) {
          average += dayEnergyUsed[i];
        }
        average = average / 7;
      } else if (timeGranularity == "month") {
        var month = selectedDate.getMonth();
        var year = selectedDate.getFullYear();

        var totalDays = daysInMonth(month, year);

        var labels = [];
        for (var i = 1; i <= totalDays; i++) {
          labels.push(i);
        }

        var endEnergy = [];
        var initialEnergyUsed = [];

        // Collect endEnergy and initialEnergyUsed
        for (var i = 1; i <= totalDays; i++) {
          for (data in energyDataset) {
            var tempTime = new Date(energyDataset[data].timestamp);
            if (tempTime.getDate() == i && tempTime.getMonth() == month && tempTime.getFullYear() == year) {
              endEnergy.push(energyDataset[data].energy);
              break;
            }
          }
          if (!endEnergy[i - 1]) {
            endEnergy.push(0);
          }
        }

        energyDataset.reverse();
        for (var i = 1; i <= totalDays; i++) {
          for (data in energyDataset) {
            var tempTime = new Date(energyDataset[data].timestamp);
            if (tempTime.getDate() == i && tempTime.getMonth() == month && tempTime.getFullYear() == year) {
              initialEnergyUsed.push(energyDataset[data].energy);
              break;
            }
          }
          if (!endEnergy[i - 1]) {
            initialEnergyUsed.push(0);
          }
        }
        energyDataset.reverse();

        // Calculate EnergyUsed
        var dayEnergyUsed = [];
        for (var i = 0; i < totalDays; i++) {
          dayEnergyUsed.push(endEnergy[i] - initialEnergyUsed[i]);
        }


        var average = 0;
        for (var i = 0; i < totalDays; i++) {
          average += dayEnergyUsed[i];
        }
        average = average / totalDays;
        return [dayEnergyUsed, labels, average];
      } else if (timeGranularity == "year") {
        var month = selectedDate.getMonth();
        var year = selectedDate.getFullYear();
        var labels = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        var ddmmyy = [];
        for (var i = 0; i < 12; i++) {
          var tempDate = new Date(year, i, 1);
          ddmmyy.push(tempDate);
        }
        var endEnergy = [];
        var initalEnergyUsed = [];

        for (date in ddmmyy) {
          var month = ddmmyy[date].getMonth();
          var year = ddmmyy[date].getFullYear();
          for (data in energyDataset) {
            var tempTime = new Date(energyDataset[data].timestamp);
            if (tempTime.getMonth() == month && tempTime.getFullYear() == year) {
              endEnergy.push(energyDataset[data].energy);
              break;
            }
          }
          if (!endEnergy[date]) {
            endEnergy.push(0);
          }
        }
        energyDataset.reverse();
        for (date in ddmmyy) {
          var month = ddmmyy[date].getMonth();
          var year = ddmmyy[date].getFullYear();
          for (data in energyDataset) {
            var tempTime = new Date(energyDataset[data].timestamp);
            if (tempTime.getMonth() == month && tempTime.getFullYear() == year) {
              initalEnergyUsed.push(energyDataset[data].energy);
              break;
            }
          }
          if (!endEnergy[date]) {
            initalEnergyUsed.push(0);
          }
        }
        energyDataset.reverse();
        var dayEnergyUsed = []
        for (var i = 0; i < 12; i++) {
          dayEnergyUsed.push(endEnergy[i] - initalEnergyUsed[i]);
        }

        var average = 0;
        for (var i = 0; i < 12; i++) {
          average += dayEnergyUsed[i];
        }
        average = average / 12;
      }
      return [dayEnergyUsed, labels, average];

    }

    $('#timeGranularity').on('change', function() {
      loadEnergyChart();
    });

    $('#datepicker').on('change', function() {
      selectedDay = $('#datepicker').val();
      loadEnergyChart();
    });

    loadEnergyChart();
    updateEnergy();
  </script>
  <script>
    $(document).ready(function() {
      $('#warning').on('click', function() {
        $('#warning').text("🠡 Alerts");
        $('#offcanvas').offcanvas('show')
      });
    });
  </script>
</body>

</html>